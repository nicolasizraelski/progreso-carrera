<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progreso - Ing. en Sistemas de InformaciÃ³n - UTN FRBA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ“</text></svg>">
    <style>
        :root {
            --bg: #0a0e1a;
            --bg-card: #131829;
            --bg-card-hover: #1a2035;
            --border: #2a3050;
            --text: #e0e4f0;
            --text-dim: #7a8099;
            --no-cursada: #2a3050;
            --cursada: #b8860b;
            --cursada-bg: rgba(184, 134, 11, 0.15);
            --cursada-border: #b8860b;
            --aprobada: #22c55e;
            --aprobada-bg: rgba(34, 197, 94, 0.15);
            --aprobada-border: #22c55e;
            --cursando: #e0e4f0;
            --cursando-bg: rgba(224, 228, 240, 0.1);
            --cursando-border: rgba(224, 228, 240, 0.5);
            --locked: #ff4757;
            --locked-bg: rgba(255, 71, 87, 0.08);
            --accent: #6366f1;
            --accent-light: #818cf8;
            --year-1: #6366f1;
            --year-2: #8b5cf6;
            --year-3: #a855f7;
            --year-4: #d946ef;
            --year-5: #ec4899;
            --integrador: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #131829 0%, #1a1040 100%);
            border-bottom: 1px solid var(--border);
            padding: 20px 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-light), var(--year-5));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-subtitle {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 2px;
        }

        .progress-container {
            display: flex;
            gap: 25px;
            align-items: center;
            flex-wrap: wrap;
        }

        .progress-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 180px;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
        }

        .progress-bar {
            height: 8px;
            background: var(--no-cursada);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill-aprobada {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #4ade80);
            border-radius: 4px;
            transition: width 0.5s ease;
            position: absolute;
            left: 0; top: 0;
        }

        .progress-fill-cursada {
            height: 100%;
            background: linear-gradient(90deg, #b8860b, #d4a017);
            border-radius: 4px;
            transition: width 0.5s ease;
            position: absolute;
            left: 0; top: 0;
        }

        .progress-numbers { font-size: 0.85rem; font-weight: 600; color: var(--text); }
        .progress-detail { font-size: 0.7rem; color: var(--text-dim); }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text);
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        .hours-toggle { display: flex; align-items: center; gap: 8px; }
        .toggle-switch { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; inset: 0;
            background: var(--border); border-radius: 20px; transition: 0.3s;
        }
        .toggle-slider::before {
            content: ''; position: absolute; height: 14px; width: 14px;
            left: 3px; bottom: 3px; background: var(--text-dim);
            border-radius: 50%; transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--accent); }
        .toggle-switch input:checked + .toggle-slider::before { transform: translateX(16px); background: white; }
        .toggle-text { font-size: 0.75rem; color: var(--text-dim); line-height: 1.2; }
        .toggle-disclaimer { font-size: 0.65rem; color: var(--cursada); opacity: 0.8; }

        body.hours-hidden .progress-item-horas { display: none; }
        body.hours-hidden .subject-hours { display: none; }

        /* Plan switcher */
        .plan-switcher {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .plan-btn {
            padding: 7px 16px;
            border: none;
            background: var(--bg-card);
            color: var(--text-dim);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-btn:not(:last-child) {
            border-right: 1px solid var(--border);
        }

        .plan-btn.active {
            background: var(--accent);
            color: #fff;
        }

        .plan-btn:hover:not(.active) {
            background: var(--bg-card-hover);
        }

        .legend {
            display: flex;
            gap: 15px;
            padding: 10px 30px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            justify-content: center;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .legend-dot { width: 12px; height: 12px; border-radius: 3px; }

        .map-container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 30px 30px;
            position: relative;
        }

        .arrows-svg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .arrows-svg path {
            fill: none;
            stroke: var(--border);
            stroke-width: 1.5;
            opacity: 0.35;
            transition: all 0.3s;
        }

        .arrows-svg path.active { stroke: var(--aprobada); opacity: 0.6; stroke-width: 1.8; }
        .arrows-svg path.cursando-arrow { stroke: var(--cursando); opacity: 0.4; }
        .arrows-svg path.cursada-arrow { stroke: var(--cursada); opacity: 0.5; }
        .arrows-svg marker path { opacity: 1; }

        .year-row {
            display: flex;
            gap: 16px;
            margin-bottom: 28px;
            align-items: stretch;
            position: relative;
            z-index: 2;
        }

        .year-label {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            padding: 12px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 48px;
            letter-spacing: 1px;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .year-1-label { background: linear-gradient(180deg, rgba(99,102,241,0.3), rgba(99,102,241,0.1)); color: var(--year-1); border: 1px solid rgba(99,102,241,0.3); }
        .year-2-label { background: linear-gradient(180deg, rgba(139,92,246,0.3), rgba(139,92,246,0.1)); color: var(--year-2); border: 1px solid rgba(139,92,246,0.3); }
        .year-3-label { background: linear-gradient(180deg, rgba(168,85,247,0.3), rgba(168,85,247,0.1)); color: var(--year-3); border: 1px solid rgba(168,85,247,0.3); }
        .year-4-label { background: linear-gradient(180deg, rgba(217,70,239,0.3), rgba(217,70,239,0.1)); color: var(--year-4); border: 1px solid rgba(217,70,239,0.3); }
        .year-5-label { background: linear-gradient(180deg, rgba(236,72,153,0.3), rgba(236,72,153,0.1)); color: var(--year-5); border: 1px solid rgba(236,72,153,0.3); }

        .year-subjects {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            flex: 1;
            align-content: flex-start;
            padding: 6px 0;
        }

        .subject-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            min-width: 170px;
            max-width: 210px;
            flex: 1 1 170px;
            user-select: none;
        }

        .subject-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .subject-card.locked { opacity: 0.4; border-color: rgba(255, 71, 87, 0.3); cursor: not-allowed; }
        .subject-card.locked:hover { transform: none; box-shadow: none; }
        .subject-card.no-cursada { border-color: var(--border); }
        .subject-card.cursando { border-color: var(--cursando-border); background: var(--cursando-bg); box-shadow: 0 0 12px rgba(224, 228, 240, 0.08); }
        .subject-card.cursada { border-color: var(--cursada-border); background: var(--cursada-bg); box-shadow: 0 0 12px rgba(184, 134, 11, 0.1); }
        .subject-card.aprobada { border-color: var(--aprobada-border); background: var(--aprobada-bg); box-shadow: 0 0 12px rgba(34, 197, 94, 0.1); }

        .subject-name { font-size: 0.8rem; font-weight: 600; line-height: 1.35; margin-bottom: 8px; }

        .subject-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.68rem;
            color: var(--text-dim);
            gap: 6px;
        }

        .subject-code { opacity: 0.7; }
        .subject-hours { background: rgba(255,255,255,0.06); padding: 2px 7px; border-radius: 4px; white-space: nowrap; }
        .subject-period-tag { font-size: 0.6rem; padding: 1px 6px; border-radius: 3px; background: rgba(255,255,255,0.04); color: var(--text-dim); white-space: nowrap; }

        .subject-state-indicator { position: absolute; top: 8px; right: 8px; width: 9px; height: 9px; border-radius: 50%; }
        .subject-card.no-cursada .subject-state-indicator { background: var(--no-cursada); border: 1px solid var(--border); }
        .subject-card.cursando .subject-state-indicator { background: var(--cursando); box-shadow: 0 0 6px var(--cursando); }
        .subject-card.cursada .subject-state-indicator { background: var(--cursada); box-shadow: 0 0 6px var(--cursada); }
        .subject-card.aprobada .subject-state-indicator { background: var(--aprobada); box-shadow: 0 0 6px var(--aprobada); }
        .subject-card.locked .subject-state-indicator { background: var(--locked); opacity: 0.5; }

        .integrador-badge { position: absolute; top: -1px; left: 12px; background: var(--integrador); color: #000; font-size: 0.55rem; font-weight: 700; padding: 1px 6px; border-radius: 0 0 4px 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .electiva-badge { background: var(--accent); color: #fff; font-size: 0.55rem; font-weight: 600; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-bottom: 4px; }

        .tooltip-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 500; background: rgba(0,0,0,0.5); }
        .tooltip-overlay.active { display: flex; align-items: center; justify-content: center; }

        .tooltip-box { background: #1a2035; border: 1px solid var(--border); border-radius: 12px; padding: 24px 28px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .tooltip-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
        .tooltip-code { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 14px; }
        .tooltip-section { margin-bottom: 12px; }
        .tooltip-section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 5px; }
        .tooltip-list { font-size: 0.8rem; padding-left: 16px; line-height: 1.7; }
        .tooltip-list li.met { color: var(--aprobada); }
        .tooltip-list li.unmet { color: var(--locked); }

        .tooltip-actions { display: flex; gap: 8px; margin-top: 18px; }
        .tooltip-btn { flex: 1; padding: 9px; border-radius: 7px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.2s; }
        .tooltip-btn.set-no-cursada { background: var(--no-cursada); color: var(--text); }
        .tooltip-btn.set-cursando { background: rgba(224, 228, 240, 0.15); color: var(--cursando); border: 1px solid var(--cursando-border); }
        .tooltip-btn.set-cursada { background: rgba(184, 134, 11, 0.3); color: var(--cursada); border: 1px solid var(--cursada); }
        .tooltip-btn.set-aprobada { background: rgba(34, 197, 94, 0.3); color: var(--aprobada); border: 1px solid var(--aprobada); }
        .tooltip-btn:hover { filter: brightness(1.2); }
        .tooltip-btn.active-state { box-shadow: 0 0 0 2px #fff; }

        @media (max-width: 1200px) { .subject-card { min-width: 145px; max-width: 190px; } }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .progress-container { width: 100%; }
            .progress-item { flex: 1; min-width: 140px; }
            .year-row { flex-direction: column; }
            .year-label { writing-mode: horizontal-tb; transform: none; min-width: auto; padding: 8px 14px; }
            .subject-card { max-width: 100%; }
            .map-container { padding: 20px 15px; }
        }

        .year-progress { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
        .year-progress-bar { height: 4px; flex: 1; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
        .year-progress-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .year-progress-text { font-size: 0.6rem; color: var(--text-dim); white-space: nowrap; }
        .ultima-exigencia { font-size: 0.6rem; color: var(--year-5); font-style: italic; margin-top: 3px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-content">
        <div>
            <h1>IngenierÃ­a en Sistemas de InformaciÃ³n</h1>
            <div class="header-subtitle" id="plan-subtitle">UTN FRBA â€” Plan 2008 (Ordenanza 1150)</div>
        </div>
        <div class="plan-switcher">
            <button class="plan-btn active" id="btn-k08" onclick="switchPlan('k08')">Plan 2008</button>
            <button class="plan-btn" id="btn-k23" onclick="switchPlan('k23')">Plan 2023</button>
        </div>
        <div class="progress-container">
            <div class="progress-item">
                <div class="progress-label">
                    <span>Materias</span>
                    <span class="progress-numbers" id="materias-count">0 / 0</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill-cursada" id="materias-cursada-bar" style="width:0%"></div>
                    <div class="progress-fill-aprobada" id="materias-aprobada-bar" style="width:0%"></div>
                </div>
                <div class="progress-detail" id="materias-detail">0 aprobadas Â· 0 cursadas</div>
            </div>
            <div class="progress-item progress-item-horas">
                <div class="progress-label">
                    <span>Hs Totales Cursada</span>
                    <span class="progress-numbers" id="horas-count">0 / 0 hs</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill-cursada" id="horas-cursada-bar" style="width:0%"></div>
                    <div class="progress-fill-aprobada" id="horas-aprobada-bar" style="width:0%"></div>
                </div>
                <div class="progress-detail" id="horas-detail">0 hs aprobadas Â· 0 hs cursadas</div>
            </div>
            <div class="progress-item">
                <div class="progress-label">
                    <span>Progreso General</span>
                    <span class="progress-numbers" id="pct-count">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill-aprobada" id="pct-bar" style="width:0%"></div>
                </div>
            </div>
        </div>
        <div class="controls">
            <!-- Toggle de horas (datos no oficiales â€” descomentar cuando se verifiquen)
            <div class="hours-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="hours-toggle" onchange="toggleHours()">
                    <span class="toggle-slider"></span>
                </label>
                <div>
                    <div class="toggle-text">Mostrar horas</div>
                    <div class="toggle-disclaimer">Datos no oficiales</div>
                </div>
            </div>
            -->
            <button class="btn" onclick="resetAll()">Resetear</button>
            <!-- <button class="btn" onclick="exportData()">Exportar</button> -->
        </div>
    </div>
</div>

<div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--locked);opacity:0.5"></div> Bloqueada</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--no-cursada);border:1px solid var(--border)"></div> Habilitada</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--cursando)"></div> Cursando</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--cursada)"></div> Cursada (Regular)</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--aprobada)"></div> Aprobada</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--integrador)"></div> Integradora</div>
    <span style="color:var(--text-dim);font-size:0.75rem;margin-left:10px">Click en una materia para ver detalles</span>
</div>

<div class="map-container" id="map-container"></div>

<div class="tooltip-overlay" id="tooltip-overlay" onclick="closeTooltip(event)">
    <div class="tooltip-box" id="tooltip-box" onclick="event.stopPropagation()">
        <div class="tooltip-title" id="tt-title"></div>
        <div class="tooltip-code" id="tt-code"></div>
        <div id="tt-body"></div>
        <div class="tooltip-actions" id="tt-actions"></div>
    </div>
</div>

<script>
// ========== PLAN K08 DATA ==========
const subjectsK08 = [
    // 1Â° NIVEL â€” totalHours en h reloj (Ord. 1150: h cÃ¡tedra Ã— 0.75)
    { id: "950701", name: "Ãlgebra y GeometrÃ­a AnalÃ­tica", code: "950701", hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "950702", name: "AnÃ¡lisis MatemÃ¡tico I", code: "950702", hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "082020", name: "MatemÃ¡tica Discreta", code: "082020", hours: 3, totalHours: 72, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "082021", name: "Algoritmos y Estructura de Datos", code: "082021", hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "082022", name: "Arquitectura de Computadoras", code: "082022", hours: 4, totalHours: 96, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "082023", name: "Sistemas y Organizaciones", code: "082023", hours: 3, totalHours: 72, year: 1, period: "Anual", integrador: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "081420", name: "QuÃ­mica", code: "081420", hours: 3, totalHours: 72, year: 1, period: "1C", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "081604", name: "IngenierÃ­a y Sociedad", code: "081604", hours: 4, totalHours: 48, year: 1, period: "2C", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 2Â° NIVEL
    { id: "082024", name: "AnÃ¡lisis de Sistemas", code: "082024", hours: 6, totalHours: 144, year: 2, period: "Anual", integrador: true, cursarCursada: ["082023", "082021"], cursarAprobada: [], finalAprobada: ["082023", "082021"] },
    { id: "951601", name: "Sistemas de RepresentaciÃ³n", code: "951601", hours: 3, totalHours: 72, year: 2, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "950703", name: "AnÃ¡lisis MatemÃ¡tico II", code: "950703", hours: 5, totalHours: 120, year: 2, period: "Anual", cursarCursada: ["950702", "950701"], cursarAprobada: [], finalAprobada: ["950702", "950701"] },
    { id: "082025", name: "Sintaxis y SemÃ¡ntica de los Lenguajes", code: "082025", hours: 4, totalHours: 96, year: 2, period: "Anual", cursarCursada: ["082020", "082021"], cursarAprobada: [], finalAprobada: ["082020", "082021"] },
    { id: "950605", name: "FÃ­sica I", code: "950605", hours: 5, totalHours: 120, year: 2, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "082026", name: "Paradigmas de ProgramaciÃ³n", code: "082026", hours: 4, totalHours: 96, year: 2, period: "Anual", cursarCursada: ["082020", "082021"], cursarAprobada: [], finalAprobada: ["082020", "082021"] },
    { id: "951602", name: "InglÃ©s I", code: "951602", hours: 4, totalHours: 48, year: 2, period: "1C", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "950704", name: "Probabilidad y EstadÃ­stica", code: "950704", hours: 6, totalHours: 72, year: 2, period: "2C", cursarCursada: ["950702", "950701"], cursarAprobada: [], finalAprobada: ["950702", "950701"] },

    // 3Â° NIVEL
    { id: "082028", name: "DiseÃ±o de Sistemas", code: "082028", hours: 6, totalHours: 144, year: 3, period: "Anual", integrador: true, cursarCursada: ["082024", "082026"], cursarAprobada: ["082021", "082023"], finalAprobada: ["082024", "082026"] },
    { id: "082027", name: "Sistemas Operativos", code: "082027", hours: 8, totalHours: 96, year: 3, period: "1C", cursarCursada: ["082020", "082021", "082022"], cursarAprobada: [], finalAprobada: ["082020", "082021", "082022"] },
    { id: "950606", name: "FÃ­sica II", code: "950606", hours: 10, totalHours: 120, year: 3, period: "1C", cursarCursada: ["950702", "950605"], cursarAprobada: [], finalAprobada: ["950702", "950605"] },
    { id: "950309", name: "EconomÃ­a", code: "950309", hours: 6, totalHours: 72, year: 3, period: "1C", cursarCursada: ["082024"], cursarAprobada: ["082021", "082023"], finalAprobada: ["082024"] },
    { id: "082030", name: "GestiÃ³n de Datos", code: "082030", hours: 8, totalHours: 96, year: 3, period: "2C", cursarCursada: ["082024", "082026", "082025"], cursarAprobada: ["082020", "082021", "082023"], finalAprobada: ["082024", "082026", "082025"] },
    { id: "951603", name: "InglÃ©s II", code: "951603", hours: 4, totalHours: 48, year: 3, period: "2C", cursarCursada: ["951602"], cursarAprobada: [], finalAprobada: ["951602"] },
    { id: "082032", name: "MatemÃ¡tica Superior", code: "082032", hours: 8, totalHours: 96, year: 3, period: "2C", cursarCursada: ["950703", "950701"], cursarAprobada: [], finalAprobada: ["950703"] },
    { id: "950310", name: "LegislaciÃ³n", code: "950310", hours: 4, totalHours: 48, year: 3, period: "2C", cursarCursada: ["082024", "081604"], cursarAprobada: ["082023", "082021"], finalAprobada: ["082024", "081604"] },
    { id: "elec3_1", name: "Electiva 3Â° (1)", code: "Electiva", hours: 4, totalHours: 48, year: 3, period: "1C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec3_2", name: "Electiva 3Â° (2)", code: "Electiva", hours: 4, totalHours: 48, year: 3, period: "2C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 4Â° NIVEL
    { id: "082036", name: "AdministraciÃ³n de Recursos", code: "082036", hours: 6, totalHours: 144, year: 4, period: "Anual", integrador: true, cursarCursada: ["082028", "082027", "950309"], cursarAprobada: ["082022", "951602", "082024", "082023", "082026"], finalAprobada: ["082028", "082027", "950309"] },
    { id: "082038", name: "IngenierÃ­a de Software", code: "082038", hours: 6, totalHours: 72, year: 4, period: "1C", cursarCursada: ["950704", "082028", "082030"], cursarAprobada: ["082024", "082025", "082026"], finalAprobada: ["950704", "082028", "082030"] },
    { id: "082033", name: "TeorÃ­a de Control", code: "082033", hours: 6, totalHours: 72, year: 4, period: "1C", cursarCursada: ["081420", "082032"], cursarAprobada: ["950703", "950606"], finalAprobada: ["081420", "082032"] },
    { id: "082029", name: "Comunicaciones", code: "082029", hours: 8, totalHours: 96, year: 4, period: "1C", cursarCursada: ["082022", "950703", "950606"], cursarAprobada: ["950701", "950605"], finalAprobada: ["082022", "950703", "950606"] },
    { id: "082031", name: "Redes de InformaciÃ³n", code: "082031", hours: 8, totalHours: 96, year: 4, period: "2C", cursarCursada: ["082027", "082029"], cursarAprobada: ["082020", "082021", "082022", "950703", "950606"], finalAprobada: ["082027", "082029"] },
    { id: "082034", name: "InvestigaciÃ³n Operativa", code: "082034", hours: 10, totalHours: 120, year: 4, period: "2C", cursarCursada: ["950704", "082032"], cursarAprobada: ["950703"], finalAprobada: ["950704", "082032"] },
    { id: "082041", name: "SimulaciÃ³n", code: "082041", hours: 8, totalHours: 96, year: 4, period: "2C", cursarCursada: ["950704", "082032"], cursarAprobada: ["950703"], finalAprobada: ["950704", "082032"] },
    { id: "elec4_1", name: "Electiva 4Â°", code: "Electiva", hours: 6, totalHours: 96, year: 4, period: "1C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 5Â° NIVEL
    { id: "082037", name: "Proyecto Final", code: "082037", hours: 6, totalHours: 144, year: 5, period: "Anual", integrador: true, cursarCursada: ["950310", "082036", "082031", "082038"], cursarAprobada: ["081604", "082023", "951601", "082024", "950704", "082028", "082027", "082029"], finalAprobada: ["ALL"], ultimaExigencia: true },
    { id: "082040", name: "Inteligencia Artificial", code: "082040", hours: 6, totalHours: 72, year: 5, period: "1C", cursarCursada: ["082034", "082041"], cursarAprobada: ["950704", "082032"], finalAprobada: ["082034", "082041"] },
    { id: "082039", name: "AdministraciÃ³n Gerencial", code: "082039", hours: 6, totalHours: 72, year: 5, period: "1C", cursarCursada: ["082036", "082034", "082041"], cursarAprobada: ["082028", "082027", "950309", "082032", "950704"], finalAprobada: ["082036", "082034", "082041"] },
    { id: "082035", name: "Sistemas de GestiÃ³n", code: "082035", hours: 8, totalHours: 96, year: 5, period: "1C", cursarCursada: ["082036", "950704", "082034", "082041", "082028", "082032", "950309"], cursarAprobada: ["082024", "082027", "082022", "082026", "951602", "082029"], finalAprobada: ["082036", "082034", "082041"] },
    { id: "elec5_1", name: "Electiva 5Â° (1)", code: "Electiva", hours: 6, totalHours: 67, year: 5, period: "1C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5_2", name: "Electiva 5Â° (2)", code: "Electiva", hours: 6, totalHours: 67, year: 5, period: "2C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5_3", name: "Electiva 5Â° (3)", code: "Electiva", hours: 6, totalHours: 67, year: 5, period: "2C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5_4", name: "Electiva 5Â° (4)", code: "Electiva", hours: 6, totalHours: 67, year: 5, period: "2C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5_5", name: "Electiva 5Â° (5)", code: "Electiva", hours: 6, totalHours: 68, year: 5, period: "2C", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
];

// ========== PLAN K23 DATA ==========
// PerÃ­odos y horas reales semanales segÃºn imagen FRBA + Ordenanza 1877
// "Cuat" = cuatrimestral (horas reales de cursada). Annualizado = hours / 2
const subjectsK23 = [
    // 1Â° NIVEL (NÂ° 1-8) â€” totalHours = h reloj segÃºn Ord. 1877. Total nivel: 768
    { id: "k23_1",  name: "AnÃ¡lisis MatemÃ¡tico I",           code: "1",  hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_2",  name: "Ãlgebra y GeometrÃ­a AnalÃ­tica",   code: "2",  hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_3",  name: "FÃ­sica I",                        code: "3",  hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_4",  name: "InglÃ©s I",                        code: "4",  hours: 4, totalHours: 48, year: 1, period: "Cuat", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_5",  name: "LÃ³gica y Estructuras Discretas",  code: "5",  hours: 3, totalHours: 72, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_6",  name: "Algoritmos y Estructuras de Datos", code: "6", hours: 5, totalHours: 120, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_7",  name: "Arquitectura de Computadoras",    code: "7",  hours: 4, totalHours: 96, year: 1, period: "Anual", cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_8",  name: "Sistemas y Procesos de Negocio",  code: "8",  hours: 3, totalHours: 72, year: 1, period: "Anual", integrador: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 2Â° NIVEL (NÂ° 9-16) â€” Total nivel: 768
    { id: "k23_9",  name: "AnÃ¡lisis MatemÃ¡tico II",          code: "9",  hours: 5, totalHours: 120, year: 2, period: "Anual",
        cursarCursada: ["k23_1", "k23_2"], cursarAprobada: [], finalAprobada: ["k23_1", "k23_2"] },
    { id: "k23_10", name: "FÃ­sica II",                       code: "10", hours: 5, totalHours: 120, year: 2, period: "Anual",
        cursarCursada: ["k23_1", "k23_3"], cursarAprobada: [], finalAprobada: ["k23_1", "k23_3"] },
    { id: "k23_11", name: "IngenierÃ­a y Sociedad",           code: "11", hours: 4, totalHours: 48, year: 2, period: "Cuat",
        cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "k23_12", name: "InglÃ©s II",                       code: "12", hours: 4, totalHours: 48, year: 2, period: "Cuat",
        cursarCursada: ["k23_4"], cursarAprobada: [], finalAprobada: ["k23_4"] },
    { id: "k23_13", name: "Sintaxis y SemÃ¡ntica de los Lenguajes", code: "13", hours: 8, totalHours: 96, year: 2, period: "Cuat",
        cursarCursada: ["k23_5", "k23_6"], cursarAprobada: [], finalAprobada: ["k23_5", "k23_6"] },
    { id: "k23_14", name: "Paradigmas de ProgramaciÃ³n",      code: "14", hours: 8, totalHours: 96, year: 2, period: "Cuat",
        cursarCursada: ["k23_5", "k23_6"], cursarAprobada: [], finalAprobada: ["k23_5", "k23_6"] },
    { id: "k23_15", name: "Sistemas Operativos",             code: "15", hours: 8, totalHours: 96, year: 2, period: "Cuat",
        cursarCursada: ["k23_7"], cursarAprobada: [], finalAprobada: ["k23_7"] },
    { id: "k23_16", name: "AnÃ¡lisis de Sistemas de InformaciÃ³n", code: "16", hours: 6, totalHours: 144, year: 2, period: "Anual", integrador: true,
        cursarCursada: ["k23_6", "k23_8"], cursarAprobada: [], finalAprobada: ["k23_6", "k23_8"] },

    // 3Â° NIVEL (NÂ° 17-23) â€” Total nivel: 744
    { id: "k23_17", name: "Probabilidad y EstadÃ­stica",      code: "17", hours: 3, totalHours: 72, year: 3, period: "Anual",
        cursarCursada: ["k23_1", "k23_2"], cursarAprobada: ["k23_1", "k23_2"], finalAprobada: ["k23_1", "k23_2"] },
    { id: "k23_18", name: "EconomÃ­a",                        code: "18", hours: 6, totalHours: 72, year: 3, period: "Cuat",
        cursarCursada: [], cursarAprobada: ["k23_1", "k23_2"], finalAprobada: ["k23_1", "k23_2"] },
    { id: "k23_19", name: "Bases de Datos",                  code: "19", hours: 8, totalHours: 96, year: 3, period: "Cuat",
        cursarCursada: ["k23_13", "k23_16"], cursarAprobada: ["k23_5", "k23_6"], finalAprobada: ["k23_13", "k23_16"] },
    { id: "k23_20", name: "Desarrollo de Software",          code: "20", hours: 4, totalHours: 96, year: 3, period: "Cuat",
        cursarCursada: ["k23_14", "k23_16"], cursarAprobada: ["k23_5", "k23_6"], finalAprobada: ["k23_14", "k23_16"] },
    { id: "k23_21", name: "ComunicaciÃ³n de Datos",           code: "21", hours: 8, totalHours: 96, year: 3, period: "Cuat",
        cursarCursada: [], cursarAprobada: ["k23_3", "k23_7"], finalAprobada: ["k23_3", "k23_7"] },
    { id: "k23_22", name: "AnÃ¡lisis NumÃ©rico",               code: "22", hours: 3, totalHours: 72, year: 3, period: "Cuat",
        cursarCursada: ["k23_9"], cursarAprobada: ["k23_1", "k23_2"], finalAprobada: ["k23_9"] },
    { id: "k23_23", name: "DiseÃ±o de Sistemas de InformaciÃ³n", code: "23", hours: 6, totalHours: 144, year: 3, period: "Anual", integrador: true,
        cursarCursada: ["k23_14", "k23_16"], cursarAprobada: ["k23_4", "k23_6", "k23_8"], finalAprobada: ["k23_14", "k23_16"] },
    { id: "elec3k23_1", name: "Electiva 3Â°", code: "Electiva", hours: 8, totalHours: 96, year: 3, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 4Â° NIVEL (NÂ° 24-30) â€” Total nivel: 744
    { id: "k23_24", name: "LegislaciÃ³n",                     code: "24", hours: 4, totalHours: 48, year: 4, period: "Cuat",
        cursarCursada: ["k23_11"], cursarAprobada: [], finalAprobada: ["k23_11"] },
    { id: "k23_25", name: "IngenierÃ­a y Calidad de Software", code: "25", hours: 6, totalHours: 72, year: 4, period: "Cuat",
        cursarCursada: ["k23_19", "k23_20", "k23_23"], cursarAprobada: ["k23_13", "k23_14"], finalAprobada: ["k23_19", "k23_20", "k23_23"] },
    { id: "k23_26", name: "Redes de Datos",                  code: "26", hours: 8, totalHours: 96, year: 4, period: "Cuat",
        cursarCursada: ["k23_15", "k23_21"], cursarAprobada: [], finalAprobada: ["k23_15", "k23_21"] },
    { id: "k23_27", name: "InvestigaciÃ³n Operativa",         code: "27", hours: 8, totalHours: 96, year: 4, period: "Cuat",
        cursarCursada: ["k23_17", "k23_22"], cursarAprobada: [], finalAprobada: ["k23_17", "k23_22"] },
    { id: "k23_28", name: "SimulaciÃ³n",                      code: "28", hours: 6, totalHours: 72, year: 4, period: "Cuat",
        cursarCursada: ["k23_17"], cursarAprobada: ["k23_9"], finalAprobada: ["k23_17"] },
    { id: "k23_29", name: "TecnologÃ­as para la AutomatizaciÃ³n", code: "29", hours: 6, totalHours: 72, year: 4, period: "Cuat",
        cursarCursada: ["k23_10", "k23_22"], cursarAprobada: ["k23_9"], finalAprobada: ["k23_10", "k23_22"] },
    { id: "k23_30", name: "AdministraciÃ³n de Sistemas de InformaciÃ³n", code: "30", hours: 6, totalHours: 144, year: 4, period: "Anual", integrador: true,
        cursarCursada: ["k23_18", "k23_23"], cursarAprobada: ["k23_16"], finalAprobada: ["k23_18", "k23_23"] },
    { id: "elec4k23_1", name: "Electiva 4Â° (1)", code: "Electiva", hours: 6, totalHours: 72, year: 4, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec4k23_2", name: "Electiva 4Â° (2)", code: "Electiva", hours: 6, totalHours: 72, year: 4, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },

    // 5Â° NIVEL (NÂ° 31-36) â€” Total nivel: 768
    { id: "k23_31", name: "Inteligencia Artificial",         code: "31", hours: 6, totalHours: 72, year: 5, period: "Cuat",
        cursarCursada: ["k23_28"], cursarAprobada: ["k23_17", "k23_22"], finalAprobada: ["k23_28"] },
    { id: "k23_32", name: "Ciencia de Datos",                code: "32", hours: 6, totalHours: 72, year: 5, period: "Cuat",
        cursarCursada: ["k23_28"], cursarAprobada: ["k23_17", "k23_19"], finalAprobada: ["k23_28"] },
    { id: "k23_33", name: "Sistemas de GestiÃ³n",             code: "33", hours: 8, totalHours: 96, year: 5, period: "Cuat",
        cursarCursada: ["k23_18", "k23_27"], cursarAprobada: ["k23_23"], finalAprobada: ["k23_18", "k23_27"] },
    { id: "k23_34", name: "GestiÃ³n Gerencial",               code: "34", hours: 6, totalHours: 72, year: 5, period: "Cuat",
        cursarCursada: ["k23_24", "k23_30"], cursarAprobada: ["k23_18"], finalAprobada: ["k23_24", "k23_30"] },
    { id: "k23_35", name: "Seguridad en los Sistemas de InformaciÃ³n", code: "35", hours: 6, totalHours: 72, year: 5, period: "Cuat",
        cursarCursada: ["k23_26", "k23_30"], cursarAprobada: ["k23_20", "k23_21"], finalAprobada: ["k23_26", "k23_30"] },
    { id: "k23_36", name: "Proyecto Final", code: "36", hours: 6, totalHours: 144, year: 5, period: "Anual", integrador: true,
        cursarCursada: ["k23_25", "k23_26", "k23_30"], cursarAprobada: ["k23_12", "k23_20", "k23_23"], finalAprobada: ["ALL"], ultimaExigencia: true },
    { id: "elec5k23_1", name: "Electiva 5Â° (1)", code: "Electiva", hours: 4, totalHours: 48, year: 5, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5k23_2", name: "Electiva 5Â° (2)", code: "Electiva", hours: 4, totalHours: 48, year: 5, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5k23_3", name: "Electiva 5Â° (3)", code: "Electiva", hours: 4, totalHours: 48, year: 5, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5k23_4", name: "Electiva 5Â° (4)", code: "Electiva", hours: 4, totalHours: 48, year: 5, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
    { id: "elec5k23_5", name: "Electiva 5Â° (5)", code: "Electiva", hours: 4, totalHours: 48, year: 5, period: "Cuat", electiva: true, cursarCursada: [], cursarAprobada: [], finalAprobada: [] },
];

// ========== PLAN MANAGEMENT ==========
const plans = {
    k08: { subjects: subjectsK08, label: "Plan 2008 (Ordenanza 1150)", storageKey: "utn-isi-progress-k08" },
    k23: { subjects: subjectsK23, label: "Plan 2023", storageKey: "utn-isi-progress-k23" },
};

let currentPlan = 'k08';
let subjects = plans[currentPlan].subjects;
let state = {};
let showHours = localStorage.getItem('utn-isi-show-hours') === 'true';

function toggleHours() {
    showHours = document.getElementById('hours-toggle').checked;
    localStorage.setItem('utn-isi-show-hours', showHours);
    document.body.classList.toggle('hours-hidden', !showHours);
    render();
}

function initHoursToggle() {
    const el = document.getElementById('hours-toggle');
    if (el) el.checked = showHours;
    document.body.classList.toggle('hours-hidden', !showHours);
}

function switchPlan(planId) {
    // Save current state first
    saveState();
    currentPlan = planId;
    subjects = plans[currentPlan].subjects;
    loadState();
    // Update UI
    document.getElementById('btn-k08').classList.toggle('active', planId === 'k08');
    document.getElementById('btn-k23').classList.toggle('active', planId === 'k23');
    document.getElementById('plan-subtitle').textContent = `UTN FRBA â€” ${plans[currentPlan].label}`;
    localStorage.setItem('utn-isi-active-plan', currentPlan);
    render();
}

// ========== STATE ==========
function loadState() {
    const key = plans[currentPlan].storageKey;
    const saved = localStorage.getItem(key);
    if (saved) {
        state = JSON.parse(saved);
    } else {
        state = {};
        subjects.forEach(s => state[s.id] = "none");
    }
    subjects.forEach(s => { if (!state[s.id]) state[s.id] = "none"; });
}

function saveState() {
    const key = plans[currentPlan].storageKey;
    localStorage.setItem(key, JSON.stringify(state));
}

function getState(id) { return state[id] || "none"; }

function canCursar(subject) {
    if (subject.electiva) return true;
    for (const reqId of subject.cursarCursada) {
        const st = getState(reqId);
        if (st !== "cursada" && st !== "aprobada") return false;
    }
    for (const reqId of subject.cursarAprobada) {
        if (getState(reqId) !== "aprobada") return false;
    }
    return true;
}

function setState(subjectId, newState) {
    const subject = subjects.find(s => s.id === subjectId);
    if (!subject) return;
    if (newState !== "none" && !canCursar(subject)) return;
    if (newState === "none" || newState === "cursando" || newState === "cursada") cascadeDowngrade(subjectId, newState);
    state[subjectId] = newState;
    saveState();
    render();
    closeTooltip();
}

function cascadeDowngrade(subjectId, newState) {
    state[subjectId] = newState;
    subjects.forEach(dep => {
        if (dep.electiva) return;
        const depState = getState(dep.id);
        if (depState === "none") return;
        if (!canCursar(dep)) {
            state[dep.id] = "none";
            cascadeDowngrade(dep.id, "none");
        }
    });
}

function resetAll() {
    if (!confirm("Â¿Resetear todo el progreso del plan actual?")) return;
    subjects.forEach(s => state[s.id] = "none");
    saveState();
    render();
}

function exportData() {
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `utn-isi-progreso-${currentPlan}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// ========== STATS ==========
function getStats() {
    let totalMaterias = subjects.length, aprobadasCount = 0, cursadasCount = 0, cursandoCount = 0;
    let totalHoras = 0, horasAprobadas = 0, horasCursadas = 0, horasCursando = 0;
    subjects.forEach(s => {
        const hs = s.totalHours;
        totalHoras += hs;
        const st = getState(s.id);
        if (st === "aprobada") { aprobadasCount++; horasAprobadas += hs; }
        else if (st === "cursada") { cursadasCount++; horasCursadas += hs; }
        else if (st === "cursando") { cursandoCount++; horasCursando += hs; }
    });
    return { totalMaterias, aprobadasCount, cursadasCount, cursandoCount, totalHoras, horasAprobadas, horasCursadas, horasCursando };
}

function updateProgressBars() {
    const stats = getStats();
    const matAprobadaPct = (stats.aprobadasCount / stats.totalMaterias * 100);
    const matCursadaPct = ((stats.aprobadasCount + stats.cursadasCount) / stats.totalMaterias * 100);
    document.getElementById('materias-aprobada-bar').style.width = matAprobadaPct + '%';
    document.getElementById('materias-cursada-bar').style.width = matCursadaPct + '%';
    document.getElementById('materias-count').textContent = `${stats.aprobadasCount} / ${stats.totalMaterias}`;
    document.getElementById('materias-detail').textContent = `${stats.aprobadasCount} aprobadas Â· ${stats.cursadasCount} cursadas` + (stats.cursandoCount ? ` Â· ${stats.cursandoCount} cursando` : '');

    const horasAprobadaPct = (stats.horasAprobadas / stats.totalHoras * 100);
    const horasCursadaPct = ((stats.horasAprobadas + stats.horasCursadas) / stats.totalHoras * 100);
    document.getElementById('horas-aprobada-bar').style.width = horasAprobadaPct + '%';
    document.getElementById('horas-cursada-bar').style.width = horasCursadaPct + '%';
    document.getElementById('horas-count').textContent = `${stats.horasAprobadas} / ${stats.totalHoras} hs`;
    document.getElementById('horas-detail').textContent = `${stats.horasAprobadas} hs aprobadas Â· ${stats.horasCursadas} hs cursadas`;

    const pct = Math.round(stats.aprobadasCount / stats.totalMaterias * 100);
    document.getElementById('pct-bar').style.width = pct + '%';
    document.getElementById('pct-count').textContent = pct + '%';
}

// ========== TOOLTIP ==========
function showTooltip(subjectId) {
    const subject = subjects.find(s => s.id === subjectId);
    if (!subject) return;
    const periodLabel = subject.period === 'Anual' ? 'Anual' : subject.period === '1C' ? '1er Cuatrimestre' : subject.period === '2C' ? '2do Cuatrimestre' : 'Cuatrimestral';
    document.getElementById('tt-title').textContent = subject.name;
    const hoursPart = showHours ? ` Â· ${subject.hours} hs/sem Â· ${subject.totalHours} hs totales` : '';
    document.getElementById('tt-code').textContent = `NÂ° ${subject.code}${hoursPart} Â· ${periodLabel} Â· ${subject.year}Â° Nivel`;

    let bodyHtml = '';
    if (subject.electiva) {
        bodyHtml = '<div class="tooltip-section"><div class="tooltip-section-title">Requisitos</div><p style="font-size:0.8rem;color:var(--text-dim)">Ver Asignaturas Electivas del nivel correspondiente</p></div>';
    } else {
        if (subject.cursarCursada.length > 0 || subject.cursarAprobada.length > 0) {
            bodyHtml += '<div class="tooltip-section"><div class="tooltip-section-title">Requisitos para Cursar</div><ul class="tooltip-list">';
            subject.cursarCursada.forEach(reqId => {
                const req = subjects.find(s => s.id === reqId);
                if (!req) return;
                const st = getState(reqId);
                const met = st === "cursada" || st === "aprobada";
                bodyHtml += `<li class="${met ? 'met' : 'unmet'}">Cursada: ${req.name} ${met ? 'âœ“' : 'âœ—'}</li>`;
            });
            subject.cursarAprobada.forEach(reqId => {
                const req = subjects.find(s => s.id === reqId);
                if (!req) return;
                const met = getState(reqId) === "aprobada";
                bodyHtml += `<li class="${met ? 'met' : 'unmet'}">Aprobada: ${req.name} ${met ? 'âœ“' : 'âœ—'}</li>`;
            });
            bodyHtml += '</ul></div>';
        }
        if (subject.finalAprobada.length > 0) {
            bodyHtml += '<div class="tooltip-section"><div class="tooltip-section-title">Requisitos para Final</div><ul class="tooltip-list">';
            if (subject.finalAprobada.includes("ALL")) {
                bodyHtml += '<li style="color:var(--year-5)">Todas las materias (Ãšltima Exigencia AcadÃ©mica)</li>';
            } else {
                subject.finalAprobada.forEach(reqId => {
                    const req = subjects.find(s => s.id === reqId);
                    if (!req) return;
                    const met = getState(reqId) === "aprobada";
                    bodyHtml += `<li class="${met ? 'met' : 'unmet'}">Aprobada: ${req.name} ${met ? 'âœ“' : 'âœ—'}</li>`;
                });
            }
            bodyHtml += '</ul></div>';
        }
        if (subject.cursarCursada.length === 0 && subject.cursarAprobada.length === 0) {
            bodyHtml += '<div class="tooltip-section"><p style="font-size:0.8rem;color:var(--text-dim)">Sin correlativas â€” Se puede cursar directamente</p></div>';
        }
    }
    document.getElementById('tt-body').innerHTML = bodyHtml;

    const currentState = getState(subject.id);
    const canEnroll = canCursar(subject);
    let actionsHtml = '';
    actionsHtml += `<button class="tooltip-btn set-no-cursada ${currentState === 'none' ? 'active-state' : ''}" onclick="setState('${subject.id}','none')">No cursada</button>`;
    actionsHtml += `<button class="tooltip-btn set-cursando ${currentState === 'cursando' ? 'active-state' : ''}" onclick="setState('${subject.id}','cursando')" ${!canEnroll && currentState === 'none' ? 'disabled style="opacity:0.3"' : ''}>Cursando</button>`;
    actionsHtml += `<button class="tooltip-btn set-cursada ${currentState === 'cursada' ? 'active-state' : ''}" onclick="setState('${subject.id}','cursada')" ${!canEnroll && currentState === 'none' ? 'disabled style="opacity:0.3"' : ''}>Cursada</button>`;
    actionsHtml += `<button class="tooltip-btn set-aprobada ${currentState === 'aprobada' ? 'active-state' : ''}" onclick="setState('${subject.id}','aprobada')" ${!canEnroll && currentState === 'none' ? 'disabled style="opacity:0.3"' : ''}>Aprobada</button>`;
    document.getElementById('tt-actions').innerHTML = actionsHtml;
    document.getElementById('tooltip-overlay').classList.add('active');
}

function closeTooltip(event) {
    if (event && event.target !== document.getElementById('tooltip-overlay')) return;
    document.getElementById('tooltip-overlay').classList.remove('active');
}
document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.getElementById('tooltip-overlay').classList.remove('active'); });

// ========== TRANSITIVE REDUCTION ==========
function computeReducedEdges() {
    const allEdges = [];
    subjects.forEach(subject => {
        if (subject.electiva) return;
        const allReqs = [...new Set([...subject.cursarCursada, ...subject.cursarAprobada])];
        allReqs.forEach(reqId => {
            if (reqId === "ALL") return;
            if (!subjects.find(s => s.id === reqId)) return;
            allEdges.push({ from: reqId, to: subject.id });
        });
    });

    const reverseAdj = {};
    allEdges.forEach(e => {
        if (!reverseAdj[e.to]) reverseAdj[e.to] = new Set();
        reverseAdj[e.to].add(e.from);
    });

    const reduced = [];
    subjects.forEach(subject => {
        if (subject.electiva) return;
        const prereqs = reverseAdj[subject.id];
        if (!prereqs || prereqs.size === 0) return;
        const prereqList = [...prereqs];

        function getTransitivePrereqs(nodeId, visited = new Set()) {
            if (visited.has(nodeId)) return visited;
            visited.add(nodeId);
            const prs = reverseAdj[nodeId];
            if (prs) prs.forEach(p => getTransitivePrereqs(p, visited));
            return visited;
        }

        const cache = {};
        prereqList.forEach(p => { cache[p] = getTransitivePrereqs(p, new Set()); });

        prereqList.forEach(p => {
            let isRedundant = false;
            for (const q of prereqList) {
                if (q === p) continue;
                if (cache[q].has(p)) { isRedundant = true; break; }
            }
            if (!isRedundant) reduced.push({ from: p, to: subject.id });
        });
    });
    return reduced;
}

// ========== RENDER ==========
function render() {
    const container = document.getElementById('map-container');
    let html = '';
    const maxYear = Math.max(...subjects.map(s => s.year));

    for (let year = 1; year <= maxYear; year++) {
        const yearSubjects = subjects.filter(s => s.year === year);
        const yearTotal = yearSubjects.length;
        const yearAprobadas = yearSubjects.filter(s => getState(s.id) === "aprobada").length;
        const yearPct = Math.round(yearAprobadas / yearTotal * 100);

        html += `<div class="year-row">`;
        html += `<div class="year-label year-${year}-label">${year}Â° Nivel
            <div class="year-progress">
                <div class="year-progress-bar"><div class="year-progress-fill" style="width:${yearPct}%;background:var(--year-${year})"></div></div>
                <div class="year-progress-text">${yearAprobadas}/${yearTotal}</div>
            </div>
        </div>`;

        html += `<div class="year-subjects">`;
        yearSubjects.sort((a, b) => (b.integrador ? 1 : 0) - (a.integrador ? 1 : 0));
        yearSubjects.forEach(s => { html += renderCard(s); });
        html += `</div></div>`;
    }

    container.innerHTML = html;
    updateProgressBars();
    drawArrows();
}

function renderCard(subject) {
    const st = getState(subject.id);
    const locked = !canCursar(subject) && st === "none";
    const stateClass = locked ? "locked" : (st === "none" ? "no-cursada" : st);
    const periodLabel = subject.period === 'Anual' ? 'Anual' : subject.period === '1C' ? '1Â° Cuat' : subject.period === '2C' ? '2Â° Cuat' : 'Cuatrim.';

    let html = `<div class="subject-card ${stateClass}" data-id="${subject.id}" onclick="showTooltip('${subject.id}')">`;
    html += `<div class="subject-state-indicator"></div>`;
    if (subject.integrador) html += `<div class="integrador-badge">Integradora</div>`;
    if (subject.electiva) html += `<span class="electiva-badge">Electiva</span>`;
    html += `<div class="subject-name">${subject.name}</div>`;
    html += `<div class="subject-meta">`;
    html += `<span class="subject-code">NÂ° ${subject.code}</span>`;
    html += `<span class="subject-period-tag">${periodLabel}</span>`;
    html += `<span class="subject-hours">${subject.hours} hs</span>`;
    html += `</div>`;
    if (subject.ultimaExigencia) html += `<div class="ultima-exigencia">Ãšltima Exigencia AcadÃ©mica</div>`;
    html += `</div>`;
    return html;
}

// ========== ARROWS ==========
function drawArrows() {
    const existingSvg = document.querySelector('.arrows-svg');
    if (existingSvg) existingSvg.remove();

    const container = document.getElementById('map-container');
    const containerRect = container.getBoundingClientRect();

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.classList.add('arrows-svg');
    svg.setAttribute('width', containerRect.width);
    svg.setAttribute('height', container.scrollHeight);
    svg.style.height = container.scrollHeight + 'px';

    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
    ['default', 'active', 'cursando', 'cursada'].forEach(type => {
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        marker.setAttribute('id', `arrow-${type}`);
        marker.setAttribute('viewBox', '0 0 10 7');
        marker.setAttribute('refX', '10');
        marker.setAttribute('refY', '3.5');
        marker.setAttribute('markerWidth', '8');
        marker.setAttribute('markerHeight', '6');
        marker.setAttribute('orient', 'auto-start-reverse');
        const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        p.setAttribute('d', 'M 0 0 L 10 3.5 L 0 7 z');
        p.setAttribute('fill', { default: 'var(--border)', active: 'var(--aprobada)', cursando: 'var(--cursando)', cursada: 'var(--cursada)' }[type]);
        p.style.opacity = type === 'default' ? '0.4' : '0.7';
        marker.appendChild(p);
        defs.appendChild(marker);
    });
    svg.appendChild(defs);

    const reducedEdges = computeReducedEdges();
    reducedEdges.forEach(conn => {
        const fromEl = container.querySelector(`[data-id="${conn.from}"]`);
        const toEl = container.querySelector(`[data-id="${conn.to}"]`);
        if (!fromEl || !toEl) return;

        const fromRect = fromEl.getBoundingClientRect();
        const toRect = toEl.getBoundingClientRect();
        const x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
        const y1 = fromRect.bottom - containerRect.top;
        const x2 = toRect.left + toRect.width / 2 - containerRect.left;
        const y2 = toRect.top - containerRect.top;
        const dy = y2 - y1;

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M ${x1} ${y1} C ${x1} ${y1 + dy * 0.4}, ${x2} ${y1 + dy * 0.6}, ${x2} ${y2}`);

        const fromState = getState(conn.from);
        if (fromState === "aprobada") { path.classList.add('active'); path.setAttribute('marker-end', 'url(#arrow-active)'); }
        else if (fromState === "cursada") { path.classList.add('cursada-arrow'); path.setAttribute('marker-end', 'url(#arrow-cursada)'); }
        else if (fromState === "cursando") { path.classList.add('cursando-arrow'); path.setAttribute('marker-end', 'url(#arrow-cursando)'); }
        else { path.setAttribute('marker-end', 'url(#arrow-default)'); }
        svg.appendChild(path);
    });
    container.insertBefore(svg, container.firstChild);
}

let resizeTimeout;
window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => drawArrows(), 200); });

// ========== INIT ==========
const savedPlan = localStorage.getItem('utn-isi-active-plan');
if (savedPlan && plans[savedPlan]) currentPlan = savedPlan;
subjects = plans[currentPlan].subjects;
document.getElementById('btn-k08').classList.toggle('active', currentPlan === 'k08');
document.getElementById('btn-k23').classList.toggle('active', currentPlan === 'k23');
document.getElementById('plan-subtitle').textContent = `UTN FRBA â€” ${plans[currentPlan].label}`;
loadState();
initHoursToggle();
render();
</script>

</body>
</html>
